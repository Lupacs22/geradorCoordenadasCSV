<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Conversor de Coordenadas e gerador de arquivo CSV</title>
<style>
  :root { --bg:#ffffff; --card:#f6f7f8; --muted:#516072; --text:#0b0d10; --ok:#2e7d32; --err:#c62828; --border:#dde2e7; --zebra1:#ffffff; --zebra2:#f4f7fb; --hover:#e9f2ff; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin:12px 0}
  button{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--text);cursor:pointer;font-weight:600}
  button:disabled{opacity:.55;cursor:not-allowed}
  .muted{color:var(--muted)}

  /* Exemplos + textarea na mesma largura */
  .io-block{width:100%}

  /* Textarea + overlay de validação */
  .ta-wrap{position:relative;width:100%;margin-top:10px}
  .ta-wrap textarea{
    position:relative;z-index:2;background:#fff;color:#0b0d10;
    border:1px solid var(--border);border-radius:10px;
    padding:10px;width:100%;min-height:160px;
    font-family:ui-monospace,Consolas,monospace;resize:vertical;
  }
  .ta-wrap .hl{
    position:absolute;inset:0;z-index:1;padding:10px;
    pointer-events:none;white-space:pre-wrap;word-wrap:break-word;
    font-family:ui-monospace,Consolas,monospace;color:transparent;overflow:auto;
  }
  .ta-wrap textarea, .ta-wrap .hl{line-height:1.5;font-size:14px}
  .hl .errLine{ text-decoration: underline wavy var(--err) 1.5px; text-decoration-skip-ink:auto; }

  /* Controles em uma linha */
  .controls{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .radio-group{flex:1;display:flex;gap:18px;align-items:center;white-space:nowrap}

  /* Exemplos (texto simples, mono, menor) */
  .examples{
    display:grid;
    grid-template-columns:repeat(4,minmax(0,1fr));
    gap:10px;
    margin:10px 0;
    font-family:ui-monospace,Consolas,monospace;
    font-size:12px;
  }
  .examples div{white-space:nowrap}

  /* Tabela preview */
  table{width:100%;border-collapse:collapse;margin-top:12px;background:#fff;overflow:hidden;border-radius:10px;border:1px solid var(--border)}
  thead th{background:#f0f3f7;padding:10px 8px;text-align:left;border-bottom:1px solid var(--border)}
  tbody td{padding:10px 8px;border-bottom:1px solid var(--border);vertical-align:top}
  tbody tr:nth-child(odd){background:var(--zebra1)}
  tbody tr:nth-child(even){background:var(--zebra2)}
  tbody tr:hover{background:var(--hover)}
  .status-ok{color:var(--ok);font-weight:600}
  .status-err{color:var(--err);font-weight:600}
  .coordText{display:inline-block}
  .copy-btn{padding:6px 10px;border-radius:8px;white-space:nowrap;font-weight:600}

  #btnConvert{margin-left:40px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Conversor de Coordenadas e gerador de arquivo CSV</h1>

  <div class="card">
    <p>
      Insira <b>uma coordenada por linha</b> (LAT/LON em qualquer formato aceito). Linhas vazias são ignoradas. Seguem alguns exemplos abaixo:
    </p>

    <div class="io-block">
      <!-- EXEMPLOS (texto simples, sem caixa) -->
      <div class="examples">
        <div>S 22° 26,710’, W 040° 02,303’</div>
        <div>-22.40862, -41.68232</div>
        <div>22 40 44 S, 40 36 15 W</div>
        <div>17 4.433 S, 37 52.9 W</div>
        <div>22 24 31.03 S, 41 40 59.63 W</div>
        <div>24º 41.261’ S; 42º 24.036’ W</div>
        <div>N 47.6205, W 122.3493</div>
        <div>24°54'22.3"S 38°15'35.9"W</div>
        <div>47 37 N, 122 20 W</div>
        <div>47.6205 N  122.3493 W</div>
        <div>S 12° 30.500′, W 038° 45.250′</div>
        <div>12°30′45″S  038°45′15″W</div>
      </div>

      <!-- TEXTAREA + highlight -->
      <div class="ta-wrap">
        <div id="hl" class="hl" aria-hidden="true"></div>
        <textarea id="txt" placeholder="Cole aqui suas coordenadas…"></textarea>
      </div>
    </div>

    <div class="controls" style="margin-top:12px">
      <div class="radio-group" id="fmtGroup" title="Formato do CSV">
        <label><input type="radio" name="fmt" value="DD" checked> DD (Graus decimais)(GISSUB)</label>
        <label><input type="radio" name="fmt" value="DMM"> DMM (Graus + Minutos decimais)</label>
        <label><input type="radio" name="fmt" value="DMS"> DMS (Graus, Minutos e Segundos)</label>
        <label><input type="radio" name="fmt" value="UTM"> UTM</label>
      </div>
      <button id="btnConvert">Converter</button>
    </div>
  </div>

  <div class="card">
    <div id="previewWrap"></div>
    <div style="margin-top:12px">
      <button id="btnDown" disabled>Baixar CSV</button>
    </div>
  </div>
</div>

<script>
/* ===== Regex corrigido: aceita minutos mesmo sem segundos ===== */
const COORD_RE = new RegExp(
  [
    '(?:\\b(?<preHem>[NnSsEeWw])\\s*)?',       // hemisfério antes (opcional)
    '(?<deg>[-+]?\\d{1,3}(?:[.,]\\d+)?)',      // graus (int/decimal)
    '(?:\\s*(?:[°ºo]))?',                      // símbolo de grau opcional
    '(?:\\s*(?<min>\\d{1,2}(?:[.,]\\d+)?)\\s*(?:[\'’′])?)?', // minutos (opcional) com/sem símbolo
    '(?:\\s*(?<sec>\\d{1,2}(?:[.,]\\d+)?)\\s*(?:["”″])?)?',  // segundos (opcional) com/sem símbolo
    '\\s*(?<sufHem>[NnSsEeWw])?'               // hemisfério depois (opcional)
  ].join(''),
  'g'
);

/* ===== Utils ===== */
function sanitizeLine(line){
  return line.replace(/[^\dNSEWnsew.,;:\-+°ºo'’′"”″\s]/g, ' ').trim();
}
function num(str){ return str ? parseFloat(str.replace(',', '.')) : NaN; }
function toFixed6Dot(x){ return Number(x).toFixed(6).replace(',', '.'); }
function hemLetter(v,lat=true){ return lat ? (v<0?'S':'N') : (v<0?'W':'E'); }

/* ===== Parsing com papel (lat/lon) via hemisfério ===== */
function parseOne(m){
  const hem = (m.groups.preHem || m.groups.sufHem || '').toUpperCase();
  const role = (hem==='N'||hem==='S') ? 'lat' : (hem==='E'||hem==='W') ? 'lon' : null;

  let d = num(m.groups.deg);
  const hasMin = m.groups.min !== undefined && m.groups.min !== '';
  const hasSec = m.groups.sec !== undefined && m.groups.sec !== '';
  let minutes = hasMin ? num(m.groups.min) : 0;
  let seconds = hasSec ? num(m.groups.sec) : 0;

  if (hasMin || hasSec) d = Math.sign(d) * Math.abs(Math.trunc(d));

  let dec = Math.abs(d) + minutes/60 + seconds/3600;
  dec = (d < 0) ? -dec : dec;

  if (hem==='S' || hem==='W') dec = -Math.abs(dec);
  if (hem==='N' || hem==='E') dec =  Math.abs(dec);

  return { dec, role };
}

function parseLineDetailed(line){
  const raw = sanitizeLine(line);
  if(!raw) return { ok:false, error:'não reconhecido' };

  const matches = [...raw.matchAll(COORD_RE)];
  if(matches.length===0) return { ok:false, error:'não reconhecido' };

  const parts = [];
  for (const m of matches){
    const hasSignal =
      (m.groups.preHem || m.groups.sufHem) ||
      /[°ºo'’′"”″]/.test(m[0]) ||
      /[-+]/.test(m.groups.deg) ||
      /\d+[,\.]\d+/.test(m.groups.deg);
    if(!hasSignal) continue;

    const { dec, role } = parseOne(m);
    if(!Number.isFinite(dec)) return { ok:false, error:'número inválido' };
    parts.push({ dec, role });
    if(parts.length===2) break;
  }

  if(parts.length<2) return { ok:false, error:'par incompleto' };

  // decide usando hemisfério; se faltar, usa intervalo/ordem
  let lat=null, lon=null;
  const [p0,p1] = parts;

  if (p0.role==='lat') lat=p0.dec;
  if (p0.role==='lon') lon=p0.dec;
  if (p1.role==='lat') lat=p1.dec;
  if (p1.role==='lon') lon=p1.dec;

  if (lat===null && lon===null){
    if (Math.abs(p0.dec)>90 && Math.abs(p1.dec)<=90){ lon=p0.dec; lat=p1.dec; }
    else if (Math.abs(p1.dec)>90 && Math.abs(p0.dec)<=90){ lon=p1.dec; lat=p0.dec; }
    else { lat=p0.dec; lon=p1.dec; } // ambos <=90 → mantém ordem
  } else if (lat===null){
    lat = (p0.role ? p1.dec : p0.dec);
  } else if (lon===null){
    lon = (p0.role ? p1.dec : p0.dec);
  }

  if(!Number.isFinite(lat)||!Number.isFinite(lon)) return { ok:false, error:'número inválido' };
  if(Math.abs(lat)>90||Math.abs(lon)>180)         return { ok:false, error:'fora do intervalo' };

  return { ok:true, lat, lon, src:raw };
}

/* ===== Saídas com ponto decimal ===== */
function ddStrings(lat, lon){
  return [ toFixed6Dot(lat), toFixed6Dot(lon) ];
}
function dmmStrings(lat, lon){
  function one(v,latAxis){
    const hem=hemLetter(v,latAxis), av=Math.abs(v);
    const d=Math.floor(av);
    const m=((av-d)*60).toFixed(3).replace(',', '.');
    return `${d}° ${m}′ ${hem}`;
  }
  return [one(lat,true), one(lon,false)];
}
function dmsStrings(lat, lon){
  function one(v,latAxis){
    const hem=hemLetter(v,latAxis), av=Math.abs(v);
    const d=Math.floor(av);
    const mF=(av-d)*60, m=Math.floor(mF);
    const s=((mF-m)*60).toFixed(2).replace(',', '.');
    const mPad=String(m).padStart(2,'0');
    return `${d}° ${mPad}′ ${s}″ ${hem}`;
  }
  return [one(lat,true), one(lon,false)];
}

/* ===== UTM ===== */
function latLonToUTM(lat, lon){
  const a=6378137.0, f=1/298.257223563, k0=0.9996;
  const e2=f*(2-f), ep2=e2/(1-e2);
  const rad=Math.PI/180, φ=lat*rad, λ=lon*rad;
  let zone=Math.floor((lon+180)/6)+1;
  const λ0=((zone-1)*6-180+3)*rad;
  const N=a/Math.sqrt(1-e2*Math.sin(φ)**2), T=Math.tan(φ)**2, C=ep2*Math.cos(φ)**2, A=Math.cos(φ)*(λ-λ0);
  const e4=e2*e2, e6=e4*e2;
  const M=a*((1-e2/4-3*e4/64-5*e6/256)*φ -(3*e2/8+3*e4/32+45*e6/1024)*Math.sin(2*φ)
    +(15*e4/256+45*e6/1024)*Math.sin(4*φ) -(35*e6/3072)*Math.sin(6*φ));
  const x=k0*N*(A+(1-T+C)*A**3/6+(5-18*T+T**2+72*C-58*ep2)*A**5/120)+500000;
  let y=k0*(M+N*Math.tan(φ)*(A**2/2+(5-T+9*C+4*C**2)*A**4/24+(61-58*T+T**2+600*C-330*ep2)*A**6/720));
  if(lat<0) y+=10000000;
  const letters='CDEFGHJKLMNPQRSTUVWX', idx=Math.floor((lat+80)/8);
  const letter=letters[Math.max(0,Math.min(letters.length-1,idx))];
  return {zone,letter,easting:Math.round(x),northing:Math.round(y)};
}

/* ===== UI bindings ===== */
const $txt=document.getElementById('txt'), $hl=document.getElementById('hl'),
      $previewWrap=document.getElementById('previewWrap'),
      $btnConvert=document.getElementById('btnConvert'),
      $btnDown=document.getElementById('btnDown'),
      $fmtGroup=document.getElementById('fmtGroup');

let lastRows=[];

function getSelectedFmt(){
  const r=[...$fmtGroup.querySelectorAll('input[name="fmt"]')].find(x=>x.checked);
  return r ? r.value : 'DD';
}
function escapeHTML(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* highlight do textarea */
function updateHighlight(){
  const lines=$txt.value.split(/\r?\n/); let html='';
  for(const l of lines){
    if(!l.trim()){ html+='\n'; continue; }
    const p=parseLineDetailed(l);
    if(p.ok) html+=escapeHTML(l)+'\n';
    else html+=`<span class="errLine" title="${p.error}">${escapeHTML(l)}</span>\n`;
  }
  $hl.innerHTML=html; $hl.scrollTop=$txt.scrollTop; $hl.scrollLeft=$txt.scrollLeft;
}
$txt.addEventListener('input',updateHighlight);
$txt.addEventListener('scroll',()=>{$hl.scrollTop=$txt.scrollTop;$hl.scrollLeft=$txt.scrollLeft;});

/* preview */
function renderPreview(rows){
  const fmt=getSelectedFmt();

  if(rows.length===0){
    $previewWrap.innerHTML='<p class="muted">Nenhuma linha para pré-visualizar.</p>';
    $btnDown.disabled = true;
    return;
  }

  const validCount = rows.filter(r=>r.ok).length;
  $btnDown.disabled = validCount === 0;

  let html='<table><thead><tr><th>ID</th><th>Coordenadas inseridas</th><th>Coordenadas convertidas</th><th>Status</th><th>Copiar</th></tr></thead><tbody>';
  for(const r of rows){
    let converted='';
    if(r.ok){
      if(fmt==='UTM'){ const u=latLonToUTM(r.lat,r.lon); converted=`${u.zone}${u.letter} ${u.easting} ${u.northing}`; }
      else if(fmt==='DMM'){ const [a,b]=dmmStrings(r.lat,r.lon); converted=`${a} , ${b}`; }
      else if(fmt==='DMS'){ const [a,b]=dmsStrings(r.lat,r.lon); converted=`${a} , ${b}`; }
      else { const [a,b]=ddStrings(r.lat,r.lon); converted=`${a} , ${b}`; }
    }
    html+=`<tr>
      <td>${r.id}</td>
      <td><span class="coordText">${escapeHTML(r.srcLine||'')}</span></td>
      <td><span class="coordText">${escapeHTML(converted)}</span></td>
      <td>${r.ok?'<span class="status-ok">OK</span>':'<span class="status-err">'+(r.error||'erro')+'</span>'}</td>
      <td>${r.ok?'<button class="copy-btn" data-copy="'+converted+'">Copiar</button>':'<button class="copy-btn" disabled>Copiar</button>'}</td>
    </tr>`;
  }
  html+='</tbody></table>';
  $previewWrap.innerHTML=html;

  $previewWrap.querySelectorAll('.copy-btn[data-copy]').forEach(btn=>{
    btn.onclick=async()=>{
      const txt=btn.dataset.copy;
      try{ await navigator.clipboard.writeText(txt); }
      catch(e){
        const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); ta.remove();
      }
      btn.textContent='Copiado!'; setTimeout(()=>btn.textContent='Copiar',1200);
    };
  });
}

/* CSV */
function buildCSV(rows,fmt){
  const valids=rows.filter(r=>r.ok);
  if(fmt==='UTM'){
    let csv='ID;UTM_ZONE;EASTING;NORTHING\n';
    for(const r of valids){const u=latLonToUTM(r.lat,r.lon);csv+=`${r.id};${u.zone}${u.letter};${u.easting};${u.northing}\n`;}
    return csv;
  } else {
    let csv='ID;LAT;LON\n';
    for(const r of valids){
      if(fmt==='DMM'){const [a,b]=dmmStrings(r.lat,r.lon);csv+=`${r.id};${a};${b}\n`;}
      else if(fmt==='DMS'){const [a,b]=dmsStrings(r.lat,r.lon);csv+=`${r.id};${a};${b}\n`;}
      else{const [a,b]=ddStrings(r.lat,r.lon);csv+=`${r.id};${a};${b}\n`;}
    }
    return csv;
  }
}

/* converter */
function convertNow(){
  const lines=$txt.value.split(/\r?\n/); const out=[]; let id=1;
  for(const l of lines){
    if(!l.trim()) continue;
    const p=parseLineDetailed(l);
    if(p.ok) out.push({id,lat:p.lat,lon:p.lon,ok:true,srcLine:l});
    else out.push({id,ok:false,error:p.error,srcLine:l});
    id++;
  }
  lastRows=out; renderPreview(out); updateHighlight();
}
document.getElementById('btnConvert').onclick=convertNow;
$fmtGroup.onchange=()=>{ if(lastRows.length>0) renderPreview(lastRows); };

/* download */
$btnDown.onclick=()=>{ if(lastRows.length===0) return;
  const fmt=getSelectedFmt(); const csv=buildCSV(lastRows,fmt);
  if(!csv) return; const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download='coordenadas.csv'; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),0);
};

/* inicial */
updateHighlight();
</script>
</body>
</html>

